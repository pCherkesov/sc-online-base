<?php echo "<a href='".$_SERVER['PHP_SELF']."?act=".$_REQUEST['act']."' class=\"back\"><img src=\"Images/Icon/page-previous.png\" /> К общему списку</a>"; ?>

<table class="singlework_header">
	<caption>
		<center>Работа # <?php echo $this->id_r." от ".$this->original_date." - ".$this->complete_date; ?></center>
	</caption>
	<tr>
		<td>
		<?php 
        if( $this->client == 0 and ( $this->client_g_face != $this->client_face or $this->client_g_tel != $this->client_tel )) $global_client_info = "";
        else $global_client_info = "ОБЩИЕ ДАННЫЕ\nКонтакт.лицо: ".$this->client_g_face."\nТелефон: ".$this->client_g_tel.
	"\nЛОКАЛЬНЫЕ ДАННЫЕ\n";
        
        echo "<a href=\"".$_SERVER['PHP_SELF']."?act=".$_REQUEST['act']."&search=y&client=".$this->id_client."\"
        title=\"".$global_client_info."Контакт.лицо: ".$this->client_face."\">".$this->client_fio."</a><br />" . $this->client_tel; ?></td>
        
		<td><?php echo "<a title=\"Поиск по модели\" 
        href='".$_SERVER['PHP_SELF']."?act=".$_REQUEST['act']."&search=y&model=".$this->id_model."'>
        ".$this->type."<br />".$this->brand." ".$this->model."</a>"; ?></td>
		<td>Счётчик: <div id='d_count'><?php echo $this->counter; ?>
		 <img src="Images/Icon/b_edit.png" border="0" name="edit_count"
		onclick = "draw_count();" alt="Изменить счётчик" /></div>
		<input type='hidden' name='id_r' value='<?php echo $this->id_r; ?>'>
    <input type='hidden' name='old_count' value='<?php echo $this->counter; ?>'></td>
		<td>Серийный номер: <br />
		<?php echo "<a title=\"Поиск по серийному номеру\"  
    href='".$_SERVER['PHP_SELF']."?act=".$_REQUEST['act']."&search=y&serial=".$this->serial."'>".$this->serial."</a>"; ?></td>
		
		<td>Принял: <?php echo $this->prin; ?>
		<br />
		
		<?php
		if($this->worker=='*Не задан*'){
			echo "<div id='d_worker'>Работает: <select name='worker' id='worker'>";
				$query_worker="SELECT * FROM `worker` WHERE `hidden`='N' ORDER BY `worker` ASC";
				$result_worker=mysql_query($query_worker) or exit(mysql_error());
				while($line_worker=mysql_fetch_assoc($result_worker)){
					 echo "<option value=".$line_worker['id_worker'].">".$line_worker['worker']."</option>";
				}
			echo "</select>";
			echo "<img src='Images/Icon/b_edit.png' border='0' name='save_worker' alt=\"Сохранить\"
			onclick=\"doWorker(document.getElementById('worker')[document.getElementById('worker').selectedIndex].value, ".$this->id_r.");\">";
		}
		else {
			echo "<div id='d_worker'>Работает: ".$this->worker;
			echo "<img src='Images/Icon/b_drop.png' border='0' name='save_worker' alt=\"Изменить\"
			onclick=\"doWorker(1, ".$this->id_r.");\"></div>";
		}
		?>
		</td></tr>
	<tr>

		<td colspan='2'><?php echo wordwrap($this->complect, 30, "<br />"); ?>&nbsp;</td>
		<td colspan='3'><?php echo wordwrap($this->defect, 60, "<br />"); ?>&nbsp;</td>
<!--		
		<td colspan='2'><?php echo substr($this->complect, 0, 30); ?>&nbsp;</td>
		<td colspan='2'><?php echo substr($this->defect, 0, 30); ?>&nbsp;</td>

		<td>
		<?php echo "<a href='act_priema_html.php?id_r=".$this->id_r."' target='_self'>"; ?>
		<img src="Images/Icon/b_print.png" border="0" alt="Вывести на печать" /></a>
		
		<?php echo "<a href='request.php?action=edit_record&id_r=".$this->id_r."&tab_edit=0' target='_self'>"; ?>
		<img src="Images/Icon/b_usredit.png" border="0" alt="Редактиовать заказ" /></a>
		
		<?php echo "<a href='request.php?action=delete_record&id_del=".$this->id_r."' target='_self'>"; ?>
		<img src="Images/Icon/b_deltbl.png" border="0" alt="Удалить заказ" /></a>
		</td>
-->
	</tr>
</table>

<script type="text/javascript" language="JavaScript"
src="JsHttpRequest/JsHttpRequest.js"></script>

<script type="text/javascript" language="JavaScript">

function doWorker( worker, idr ) {
    // Create new JsHttpRequest object.
    var req = new JsHttpRequest();
    // Code automatically called on load finishing.
    req.onreadystatechange = function() {
        if (req.readyState == 4) {
            // Write result to page element ($_RESULT become responseJS). 
			// Write debug information too (output become responseText).
			if (req.responseJS.act == 1) {
					document.getElementById('d_worker').innerHTML = 'Работает: ' + document.getElementById('worker')[document.getElementById('worker').selectedIndex].text + '<img src="Images/Icon/b_drop.png" border="0" name="save_worker" onclick="doWorker(1, ' + req.responseJS.idr + ');">';
			}
			else {
					document.getElementById('d_worker').innerHTML = req.responseJS.worklist;
			}
//			document.getElementById('result').innerHTML = req.responseJS.worker + req.responseJS.act + req.responseJS.worklist + req.responseJS.idr;
//			document.getElementById('debug').innerHTML = req.responseText;
        }
    }
    // Prepare request object (automatically choose GET or POST).
    req.open(null, 'do_worker_loader.php', true);
    // Send data to backend.
    req.send( { worker: worker, idr: idr } );
}

function draw_count () {
	document.getElementById('d_count').innerHTML = '<input type="text" name="count" size="10" maxlen="15" value="' + document.getElementById('old_count').value + '"/>' +
	'<img src="Images/Icon/b_edit.png" border="0" name="edit_count"' + 'onclick = "doCount(document.getElementById(\'count\').value, document.getElementById(\'id_r\').value);">';
}

function doCount( count, idr ) {
    // Create new JsHttpRequest object.
    var req = new JsHttpRequest();
    // Code automatically called on load finishing.
    req.onreadystatechange = function() {
        if (req.readyState == 4) {
            // Write result to page element ($_RESULT become responseJS). 
			// Write debug information too (output become responseText).
			document.getElementById('d_count').innerHTML = req.responseJS.count + ' <img src="Images/Icon/b_edit.png" border="0" name="edit_count" onclick = "draw_count();" />';
			document.getElementById('old_count').value = req.responseJS.count; 
			
      document.getElementById('result').innerHTML = req.responseJS.count + '-' + req.responseJS.idr;
			document.getElementById('debug').innerHTML = req.responseText;
        }
    }
    // Prepare request object (automatically choose GET or POST).
    req.open(null, 'do_count_loader.php', true);
    // Send data to backend.
    req.send( { count: count, idr: idr } );
}

</script>
